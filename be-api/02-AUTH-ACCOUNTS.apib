FORMAT: 1A
HOST: http://192.168.122.76:8080/v1

# Authentication & Account Management

**Service**: Identity
**Base Path**: `/v1/auth`
**Port**: 8081 (internal), proxied via gateway at :8080
**Code Location**: `/services/identity/`

---

## Overview

The Identity Service handles all authentication and account management operations. It uses JWT-based authentication with ECDSA-256 signing, Redis-backed session management, and rate limiting to prevent abuse.

**Key Features**:
- Signup with email/password
- Login with credential validation
- Token refresh with rotation (⚠️ critical behavior)
- Session management (logout single or all sessions)
- Password change (revokes all sessions)
- Account deletion (30-day grace period)

**See Also**: `01-OVERVIEW.apib` for JWT structure and global auth model

---

## Group Auth Endpoints

### POST /v1/auth/signup

Create new account and receive tokens.

**Authentication**: None (public endpoint)

**Rate Limiting**: 3 requests / hour per IP

**Request Headers**:
```
Content-Type: application/json
X-Idempotency-Key: 7f3c8e12-4a9b-4d2f-9e1a-6c8d3f2e1b4a  (optional, ❌ not enforced)
```

**Request Body**:
```json
{
  "email": "player@example.com",
  "password": "securepass123",
  "display_name": "Captain Nova"
}
```

**Request Schema**:

| Field | JSON Tag | Type | Required | Validation | Default | Notes |
|-------|----------|------|----------|------------|---------|-------|
| email | `email` | string | Yes | Email format | - | Must be unique |
| password | `password` | string | Yes | min=8 characters | - | Hashed with Argon2 |
| display_name | `display_name` | string | Yes | - | - | Player display name |

**Validation Rules** (Code: `/services/identity/internal/handlers/auth.go:142-160`):
1. **Email Format**: Must be valid email format
   - Error: `VALIDATION_ERROR` (400)
2. **Email Uniqueness**: Must not already exist
   - Error: `EMAIL_EXISTS` (409)
3. **Password Strength**: Minimum 8 characters
   - Error: `VALIDATION_PASSWORD_WEAK` (400)
4. **Display Name**: Required, non-empty
   - Error: `VALIDATION_ERROR` (400)

**Success Response** (201 Created):
```json
{
  "data": {
    "access_token": "eyJhbGci...",
    "refresh_token": "8YYgCWnj...",
    "token_type": "Bearer",
    "expires_in": 900,
    "session_id": "9f35eeac-d06f-4e08-8088-171b1de020d4"
  }
}
```

**Response Schema**:

| Field | JSON Tag | Type | Always Present | Notes |
|-------|----------|------|----------------|-------|
| access_token | `access_token` | string | Yes | JWT token, 15-minute lifetime |
| refresh_token | `refresh_token` | string | Yes | Refresh token, 30-day lifetime |
| token_type | `token_type` | string | Yes | Always "Bearer" |
| expires_in | `expires_in` | int | Yes | Seconds until access token expires (900) |
| session_id | `session_id` | string | Yes | Session UUID for logout |

**Error Responses**:

| HTTP Status | Error Code | Message | Cause |
|-------------|------------|---------|-------|
| 400 | `VALIDATION_ERROR` | "Invalid request" | Malformed JSON or missing required fields |
| 400 | `VALIDATION_PASSWORD_WEAK` | "Password must be at least 8 characters" | Password < 8 chars |
| 409 | `EMAIL_EXISTS` | "Email already registered" | Email already exists in database |
| 429 | `RATE_LIMITED` | "Rate limit exceeded" | Exceeded 3 signups/hour from IP |
| 500 | `SERVER_ERROR` | "Internal server error" | Database or service failure |

**⚠️ Idempotency Note**:
- `X-Idempotency-Key` header is accepted but **NOT enforced**
- Duplicate requests will create duplicate accounts with same email (will fail on second attempt due to unique constraint)
- Status: **Planned** for future implementation

**Code**: `/services/identity/internal/handlers/auth.go:70-180`

---

### POST /v1/auth/login

Authenticate with existing credentials.

**Authentication**: None (public endpoint)

**Rate Limiting**:
- 5 requests / 15 min per IP
- 10 requests / 15 min per account (email)

**Request Headers**:
```
Content-Type: application/json
```

**Request Body**:
```json
{
  "email": "player@example.com",
  "password": "securepass123"
}
```

**Request Schema**:

| Field | JSON Tag | Type | Required | Validation |
|-------|----------|------|----------|------------|
| email | `email` | string | Yes | Email format |
| password | `password` | string | Yes | - |

**Success Response** (200 OK):
```json
{
  "data": {
    "access_token": "eyJhbGci...",
    "refresh_token": "8YYgCWnj...",
    "token_type": "Bearer",
    "expires_in": 900,
    "session_id": "9f35eeac-d06f-4e08-8088-171b1de020d4"
  }
}
```

**Error Responses**:

| HTTP Status | Error Code | Message | Cause |
|-------------|------------|---------|-------|
| 400 | `VALIDATION_ERROR` | "Invalid request" | Malformed JSON |
| 401 | `INVALID_CREDENTIALS` | "Invalid email or password" | Wrong email/password combination |
| 403 | `ACCOUNT_SUSPENDED` | "Account suspended" | Account has been suspended by admin |
| 429 | `RATE_LIMITED` | "Rate limit exceeded" | Too many login attempts |
| 500 | `SERVER_ERROR` | "Internal server error" | Database or service failure |

**Code**: `/services/identity/internal/handlers/auth.go:185-250`

---

### POST /v1/auth/refresh

Refresh expired access token.

**Authentication**: None (uses refresh token in body)

**Rate Limiting**: 10 requests / min per IP

**⚠️ CRITICAL BEHAVIOR**: This endpoint implements **refresh token rotation**. You will receive a NEW refresh token that MUST be stored. The old refresh token is immediately revoked.

**Request Headers**:
```
Content-Type: application/json
```

**Request Body**:
```json
{
  "refresh_token": "8YYgCWnj..."
}
```

**Request Schema**:

| Field | JSON Tag | Type | Required | Validation |
|-------|----------|------|----------|------------|
| refresh_token | `refresh_token` | string | Yes | Valid JWT refresh token |

**Success Response** (200 OK):
```json
{
  "data": {
    "access_token": "eyJhbGci...",
    "refresh_token": "9ZZhDXok...",
    "token_type": "Bearer",
    "expires_in": 900
  }
}
```

**⚠️ Response Schema - Note NEW refresh_token**:

| Field | JSON Tag | Type | Always Present | Notes |
|-------|----------|------|----------------|-------|
| access_token | `access_token` | string | Yes | **NEW** access token |
| refresh_token | `refresh_token` | string | Yes | **NEW** refresh token (⚠️ MUST STORE) |
| token_type | `token_type` | string | Yes | Always "Bearer" |
| expires_in | `expires_in` | int | Yes | 900 seconds |

**⚠️ CRITICAL - Token Rotation**:
1. Client sends old refresh token
2. Server validates old refresh token
3. Server generates NEW access token
4. Server generates NEW refresh token
5. Server **revokes old refresh token** (cannot be reused)
6. Client receives both new tokens
7. **Client MUST store the new refresh token**
8. If client tries to use old refresh token again: `INVALID_TOKEN` error

**Error Responses**:

| HTTP Status | Error Code | Message | Cause |
|-------------|------------|---------|-------|
| 400 | `VALIDATION_ERROR` | "Invalid request" | Missing refresh_token field |
| 401 | `INVALID_TOKEN` | "Invalid or revoked token" | Token signature invalid or already used (rotated) |
| 401 | `TOKEN_EXPIRED` | "Refresh token expired" | Refresh token past 30-day expiration |
| 429 | `RATE_LIMITED` | "Rate limit exceeded" | Too many refresh attempts |
| 500 | `SERVER_ERROR` | "Internal server error" | Database or service failure |

**Code**: `/services/identity/internal/service/auth.go:298-350` (token rotation logic)

**Example Client Flow**:
```javascript
// Store initial tokens from login
localStorage.setItem('access_token', loginResponse.access_token);
localStorage.setItem('refresh_token', loginResponse.refresh_token);

// Later, when access token expires...
const refreshResponse = await fetch('/v1/auth/refresh', {
  method: 'POST',
  body: JSON.stringify({
    refresh_token: localStorage.getItem('refresh_token')
  })
});

const tokens = (await refreshResponse.json()).data;

// ⚠️ CRITICAL: Store BOTH new tokens
localStorage.setItem('access_token', tokens.access_token);
localStorage.setItem('refresh_token', tokens.refresh_token);  // NEW refresh token!
```

---

### POST /v1/auth/logout

Revoke current session or all sessions.

**Authentication**: Required (JWT Bearer token)

**Request Headers**:
```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**Request Body**:
```json
{
  "all_sessions": false
}
```

**Request Schema**:

| Field | JSON Tag | Type | Required | Validation | Default |
|-------|----------|------|----------|------------|---------|
| all_sessions | `all_sessions` | bool | No | - | false |

**Behavior**:
- If `all_sessions: false` (default): Revokes **current session only** (extracted from JWT `sid` claim)
- If `all_sessions: true`: Revokes **all sessions** for the account

**Success Response** (200 OK):
```json
{
  "data": {
    "sessions_revoked": 1
  }
}
```

**Response Schema**:

| Field | JSON Tag | Type | Always Present | Notes |
|-------|----------|------|----------------|-------|
| sessions_revoked | `sessions_revoked` | int | Yes | Number of sessions revoked (1 or all) |

**Error Responses**:

| HTTP Status | Error Code | Message | Cause |
|-------------|------------|---------|-------|
| 401 | `AUTH_REQUIRED` | "Authorization required" | Missing or invalid JWT token |
| 401 | `AUTH_INVALID_TOKEN` | "Invalid token" | JWT signature invalid |
| 401 | `AUTH_TOKEN_EXPIRED` | "Token expired" | Access token expired |
| 500 | `SERVER_ERROR` | "Internal server error" | Redis or service failure |

**Session Extraction**:
- Current session ID is extracted from JWT `sid` claim (not from request body)
- Middleware sets session ID in context: `middleware.GetSessionID(ctx)`
- Redis key format: `session:{session_id}` → deleted on logout

**Code**: `/services/identity/internal/service/auth.go:250-296`

---

### POST /v1/auth/password

Change account password.

**Authentication**: Required (JWT Bearer token)

**⚠️ CRITICAL BEHAVIOR**: Changing password **revokes ALL sessions** for security. You will receive new tokens; all other sessions must re-authenticate.

**Request Headers**:
```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**Request Body**:
```json
{
  "current_password": "oldpass123",
  "new_password": "newpass456"
}
```

**Request Schema**:

| Field | JSON Tag | Type | Required | Validation |
|-------|----------|------|----------|------------|
| current_password | `current_password` | string | Yes | - |
| new_password | `new_password` | string | Yes | min=8 characters |

**Validation**:
1. Current password must match account password
   - Error: `INVALID_CREDENTIALS` (401)
2. New password must be at least 8 characters
   - Error: `VALIDATION_PASSWORD_WEAK` (400)

**Success Response** (200 OK):
```json
{
  "data": {
    "message": "Password changed",
    "sessions_revoked": "all",
    "new_tokens": {
      "access_token": "eyJhbGci...",
      "refresh_token": "8YYgCWnj...",
      "token_type": "Bearer",
      "expires_in": 900
    }
  }
}
```

**Response Schema**:

| Field | JSON Tag | Type | Always Present | Notes |
|-------|----------|------|----------------|-------|
| message | `message` | string | Yes | Confirmation message |
| sessions_revoked | `sessions_revoked` | string | Yes | Always "all" |
| new_tokens | `new_tokens` | object | Yes | New access/refresh tokens |

**⚠️ CRITICAL - Session Revocation**:
1. Server validates current password
2. Server updates password in database
3. Server **revokes ALL sessions** in Redis (including current session)
4. Server creates **new session** and generates new tokens
5. Client receives new tokens
6. **Client MUST immediately replace tokens** with new ones
7. All other active sessions are invalidated (users must re-login)

**Error Responses**:

| HTTP Status | Error Code | Message | Cause |
|-------------|------------|---------|-------|
| 400 | `VALIDATION_ERROR` | "Invalid request" | Missing fields |
| 400 | `VALIDATION_PASSWORD_WEAK` | "Password must be at least 8 characters" | New password too short |
| 401 | `INVALID_CREDENTIALS` | "Current password incorrect" | Wrong current password |
| 401 | `AUTH_REQUIRED` | "Authorization required" | Missing JWT |
| 500 | `SERVER_ERROR` | "Internal server error" | Database failure |

**Code**: `/services/identity/internal/service/auth.go:354-410`

---

### DELETE /v1/auth/account

Schedule account deletion (30-day grace period).

**Authentication**: Required (JWT Bearer token)

**Request Headers**:
```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**Request Body**:
```json
{
  "password": "currentpass123",
  "confirm": true
}
```

**Request Schema**:

| Field | JSON Tag | Type | Required | Validation |
|-------|----------|------|----------|------------|
| password | `password` | string | Yes | Must match account password |
| confirm | `confirm` | bool | Yes | Must be `true` |

**Validation**:
1. Password must match account password
   - Error: `INVALID_CREDENTIALS` (401)
2. Confirm must be `true`
   - Error: `VALIDATION_ERROR` (400)

**Success Response** (200 OK):
```json
{
  "data": {
    "message": "Account scheduled for deletion",
    "deletion_at": "2026-01-26T12:00:00Z"
  }
}
```

**Response Schema**:

| Field | JSON Tag | Type | Always Present | Notes |
|-------|----------|------|----------------|-------|
| message | `message` | string | Yes | Confirmation message |
| deletion_at | `deletion_at` | string | Yes | RFC3339 timestamp (30 days from now) |

**Behavior**:
- Account is marked for deletion but NOT immediately deleted
- 30-day grace period allows account recovery
- All sessions are revoked immediately
- Account can be restored within 30 days by contacting support
- After 30 days, account and all associated data (characters, ships, etc.) are permanently deleted

**Error Responses**:

| HTTP Status | Error Code | Message | Cause |
|-------------|------------|---------|-------|
| 400 | `VALIDATION_ERROR` | "Confirmation required" | `confirm` not `true` |
| 401 | `INVALID_CREDENTIALS` | "Password incorrect" | Wrong password |
| 401 | `AUTH_REQUIRED` | "Authorization required" | Missing JWT |
| 500 | `SERVER_ERROR` | "Internal server error" | Database failure |

**Code**: `/services/identity/internal/handlers/auth.go:420-480`

---

### GET /v1/auth/me

Get current user profile.

**Authentication**: Required (JWT Bearer token)

**Request Headers**:
```
Authorization: Bearer {access_token}
```

**Success Response** (200 OK):
```json
{
  "data": {
    "account_id": "7f3c8e12-4a9b-4d2f-9e1a-6c8d3f2e1b4a",
    "email": "player@example.com",
    "status": "active",
    "home_region": "local",
    "profile_id": "38a87211-63b6-409b-b433-8f443e333953",
    "display_name": "Captain Nova",
    "active_sessions": 2
  }
}
```

**Response Schema**:

| Field | JSON Tag | Type | Always Present | Notes |
|-------|----------|------|----------------|-------|
| account_id | `account_id` | string | Yes | Account UUID |
| email | `email` | string | Yes | Email address |
| status | `status` | string | Yes | "active", "suspended", or "pending_deletion" |
| home_region | `home_region` | string | Yes | Server region |
| profile_id | `profile_id` | string | Yes | **Profile UUID (use for characters/ships)** |
| display_name | `display_name` | string | Yes | Player display name |
| active_sessions | `active_sessions` | int | Yes | Count of active sessions |

**Important**: Save `profile_id` for creating characters and ships.

**Error Responses**:

| HTTP Status | Error Code | Message | Cause |
|-------------|------------|---------|-------|
| 401 | `AUTH_REQUIRED` | "Authorization required" | Missing JWT |
| 401 | `AUTH_INVALID_TOKEN` | "Invalid token" | Invalid JWT |
| 500 | `SERVER_ERROR` | "Internal server error" | Database failure |

**Code**: `/services/identity/internal/handlers/auth.go:485-530`

---

### GET /v1/auth/sessions

List active sessions for current account.

**Authentication**: Required (JWT Bearer token)

**Request Headers**:
```
Authorization: Bearer {access_token}
```

**Success Response** (200 OK):
```json
{
  "data": [
    {
      "session_id": "9f35eeac-d06f-4e08-8088-171b1de020d4",
      "created_at": "2025-12-24T10:00:00Z",
      "last_active": "2025-12-24T12:00:00Z",
      "ip_address": "192.168.1.100",
      "user_agent": "Mozilla/5.0..."
    },
    {
      "session_id": "8e24ddac-c05e-3f07-7077-060a0cd919c3",
      "created_at": "2025-12-23T18:00:00Z",
      "last_active": "2025-12-24T11:30:00Z",
      "ip_address": "192.168.1.105",
      "user_agent": "MyGameClient/1.0"
    }
  ]
}
```

**Response Schema** (array of sessions):

| Field | JSON Tag | Type | Always Present | Notes |
|-------|----------|------|----------------|-------|
| session_id | `session_id` | string | Yes | Session UUID |
| created_at | `created_at` | string | Yes | RFC3339 timestamp |
| last_active | `last_active` | string | Yes | RFC3339 timestamp |
| ip_address | `ip_address` | string | Yes | IP address |
| user_agent | `user_agent` | string | Yes | User agent string |

**Use Case**: Show user all active sessions and allow them to revoke specific sessions (future feature).

**Error Responses**:

| HTTP Status | Error Code | Message | Cause |
|-------------|------------|---------|-------|
| 401 | `AUTH_REQUIRED` | "Authorization required" | Missing JWT |
| 500 | `SERVER_ERROR` | "Internal server error" | Redis failure |

**Code**: `/services/identity/internal/handlers/auth.go:535-590`

---

## Quick Start Example

```javascript
// 1. Sign up
const signupResponse = await fetch('http://192.168.122.76:8080/v1/auth/signup', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    email: 'newplayer@example.com',
    password: 'securepass123',
    display_name: 'Nova Commander'
  })
});

const {access_token, refresh_token, session_id} = (await signupResponse.json()).data;
localStorage.setItem('access_token', access_token);
localStorage.setItem('refresh_token', refresh_token);

// 2. Get profile ID (needed for characters/ships)
const meResponse = await fetch('http://192.168.122.76:8080/v1/auth/me', {
  headers: {'Authorization': `Bearer ${access_token}`}
});

const {profile_id} = (await meResponse.json()).data;
localStorage.setItem('profile_id', profile_id);

// 3. Later, refresh token when it expires
const refreshResponse = await fetch('http://192.168.122.76:8080/v1/auth/refresh', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    refresh_token: localStorage.getItem('refresh_token')
  })
});

const newTokens = (await refreshResponse.json()).data;
// ⚠️ CRITICAL: Store NEW refresh token
localStorage.setItem('access_token', newTokens.access_token);
localStorage.setItem('refresh_token', newTokens.refresh_token);

// 4. Logout
await fetch('http://192.168.122.76:8080/v1/auth/logout', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({all_sessions: false})
});

localStorage.removeItem('access_token');
localStorage.removeItem('refresh_token');
localStorage.removeItem('profile_id');
```

---

## Code Pointers

**Handler Functions**:
- Signup: `/services/identity/internal/handlers/auth.go:70-180`
- Login: `/services/identity/internal/handlers/auth.go:185-250`
- Refresh: `/services/identity/internal/handlers/auth.go:255-297`
- Logout: `/services/identity/internal/handlers/auth.go:302-350`
- Password Change: `/services/identity/internal/handlers/auth.go:355-415`
- Account Deletion: `/services/identity/internal/handlers/auth.go:420-480`
- Get Me: `/services/identity/internal/handlers/auth.go:485-530`
- Get Sessions: `/services/identity/internal/handlers/auth.go:535-590`

**Service Logic**:
- Token generation: `/services/identity/internal/service/auth.go:198-245`
- Token refresh with rotation: `/services/identity/internal/service/auth.go:298-350`
- Session management: `/services/identity/internal/service/auth.go:250-296`
- Password change: `/services/identity/internal/service/auth.go:354-410`

**Middleware**:
- Auth middleware: `/pkg/middleware/auth.go:45-120`
- Rate limiting: `/pkg/middleware/ratelimit.go`

---

**Next**: See `03A-IDENTITY.apib` for character and ship creation.
