FORMAT: 1A
HOST: http://192.168.122.76:8080/v1

# SSW Galaxy MMO - Economy & Markets (vNext 2.0)

**Version**: 2.0 (vNext)
**Status**: Implementation-Grounded
**Last Verified**: 2025-12-27
**Service**: Economy (Internal Port: 8084)

---

## Document Purpose

This document covers the **Economy Service**, responsible for:
- **Markets**: Station-based commodity trading
- **Order Books**: Buy/sell order matching with price-time priority
- **Price Discovery**: Dynamic pricing based on supply/demand and events
- **Trade Execution**: Automated matching and settlement

**Code**: `/services/economy/`

**Related Documents**:
- See `01-OVERVIEW.apib` for global standards
- See `04-REALTIME-SSE.apib` for economy event subscriptions
- See `06-APPENDICES.md` for commodity reference

---

## Economy Overview

### Market System

SSW Galaxy MMO features a **player-driven economy** with station-based markets:
- Each station has a market with multiple commodities
- Players place buy/sell orders (limit orders)
- Orders matched automatically when prices cross
- Prices determined by supply/demand dynamics

**Market Model**: Order book with bids (buy orders) and asks (sell orders)

**Price Discovery**: Volume-weighted average price (VWAP) with dynamic modifiers

---

### Commodities

**Default Commodities** (10 types):
| Commodity | Tier | Typical Use | Base Price |
|-----------|------|-------------|------------|
| `ore` | 1 | Crafting raw materials | 100 |
| `gas` | 1 | Fuel production | 150 |
| `water` | 1 | Life support, fuel | 80 |
| `organic` | 2 | Food, medicine production | 200 |
| `crystals` | 2 | Electronics, weapons | 300 |
| `fuel` | 2 | Ship propulsion | 250 |
| `electronics` | 3 | Ship components, stations | 500 |
| `weapons` | 3 | Combat equipment | 600 |
| `medicine` | 3 | Healing, buffs | 450 |
| `luxury` | 3 | High-value trade goods | 800 |

**Note**: Prices fluctuate based on supply/demand, events, and player trading

**Code**: `/services/economy/cmd/main.go:179-190`

---

### Markets

**Default Markets**:
1. **market_sol_station**: Sol System main trade hub (safest, high volume)
2. **market_alpha_hub**: Alpha Centauri trade hub (high volume)
3. **market_frontier_post**: Frontier trading post (riskier, price volatility)

**Market Initialization**: Each market supports all 10 commodities

**Market Selection**: Players must be docked at station to access its market

**Code**: `/services/economy/cmd/main.go:192-195`

---

### Order Book Mechanics

**Order Types**:
- **Limit Orders Only**: Specify exact price and quantity
- No market orders (instant buy/sell) in v1

**Order Matching**:
1. Buy order placed at price X
2. System checks if any sell orders exist at price ≤ X
3. If yes, match and execute trade
4. If partial match, remaining quantity stays in order book
5. If no match, order added to book (pending)

**Price-Time Priority**:
- Best price matched first (highest bid, lowest ask)
- Same price: first-in-first-out (FIFO)

**Code**: `/services/economy/internal/orderbook/book.go:224-236`

---

### Order Status

| Status | Description |
|--------|-------------|
| `pending` | Order in book, awaiting match |
| `partial` | Partially filled, remaining quantity in book |
| `filled` | Completely filled, removed from book |
| `canceled` | Manually canceled by player |
| `expired` | Expired due to time limit (future feature) |

---

## Endpoints

### POST /markets/{market_id}/orders

Place a buy or sell order.

**Authentication**: Required

**URL Parameters**:
- `market_id` (required): Market ID (e.g., `market_sol_station`)

**Request Body**:
```json
{
  "player_id": "player-uuid-1",
  "commodity": "ore",
  "side": "buy",
  "price": "105.50",
  "quantity": 100
}
```

**Validation Rules**:
- `player_id`: Must match authenticated profile ID
- `commodity`: Must be valid commodity for this market
- `side`: Must be `buy` or `sell`
- `price`: Decimal string (e.g., "100.00"), must be > 0
- `quantity`: Integer, must be > 0
- **Buy orders**: Player must have sufficient credits (price × quantity)
- **Sell orders**: Player must have sufficient inventory quantity

**Response** (200 OK - Fully Filled):
```json
{
  "data": {
    "order_id": "order-uuid-1",
    "status": "filled",
    "fills": [
      {
        "fill_id": "fill-uuid-1",
        "matched_id": "order-uuid-2",
        "price": "105.00",
        "quantity": 100,
        "timestamp": "2025-12-27T12:34:56.123456Z"
      }
    ]
  }
}
```

**Response** (200 OK - Partial Fill):
```json
{
  "data": {
    "order_id": "order-uuid-1",
    "status": "partial",
    "fills": [
      {
        "fill_id": "fill-uuid-1",
        "matched_id": "order-uuid-2",
        "price": "105.00",
        "quantity": 60,
        "timestamp": "2025-12-27T12:34:56.123456Z"
      }
    ]
  }
}
```

**Response** (200 OK - No Match):
```json
{
  "data": {
    "order_id": "order-uuid-1",
    "status": "pending",
    "fills": []
  }
}
```

**Field Descriptions**:
- `status`: Current order status after placement
- `fills`: List of trades executed during order placement
  - `matched_id`: Order ID that this order was matched against
  - `price`: Execution price (may differ from order price if matched)
  - `quantity`: Quantity filled in this match

**Effects**:
- **Buy order filled**: Credits deducted, inventory updated
- **Sell order filled**: Credits added, inventory reduced
- **Partial/pending**: Credits/inventory locked for pending quantity
- Publishes `game.economy.trade` event via NATS

**Error Codes**:
- `VALIDATION_ERROR` (400) - Invalid request body or price format
- `MARKET_NOT_FOUND` (404) - Market or commodity does not exist
- `INSUFFICIENT_CREDITS` (400) - Not enough credits for buy order
- `INSUFFICIENT_INVENTORY` (400) - Not enough inventory for sell order
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/economy/internal/handlers/economy.go:41-122`

---

### DELETE /markets/{market_id}/orders/{order_id}

Cancel a pending or partial order.

**Authentication**: Required

**URL Parameters**:
- `market_id` (required): Market ID
- `order_id` (required): Order UUID

**Query Parameters**:
- `commodity` (required): Commodity type (e.g., "ore")
- `side` (required): Order side ("buy" or "sell")

**Response** (200 OK):
```json
{
  "data": {
    "success": true
  }
}
```

**Effects**:
- Order removed from order book
- Locked credits/inventory released back to player
- Cannot cancel filled orders

**Error Codes**:
- `VALIDATION_ERROR` (400) - Missing commodity or side query params
- `MARKET_NOT_FOUND` (404) - Market or commodity does not exist
- `ORDER_NOT_FOUND` (404) - Order does not exist or already filled
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/economy/internal/handlers/economy.go:124-164`

---

### GET /markets/{market_id}/orderbook

Get current order book for a commodity (best bid, best ask, spread).

**Authentication**: Required

**URL Parameters**:
- `market_id` (required): Market ID

**Query Parameters**:
- `commodity` (required): Commodity type (e.g., "ore")

**Response** (200 OK):
```json
{
  "data": {
    "market_id": "market_sol_station",
    "commodity": "ore",
    "best_bid": "104.50",
    "best_ask": "106.00",
    "spread": "1.50",
    "midpoint": "105.25"
  }
}
```

**Field Descriptions**:
- `best_bid`: Highest buy order price (what buyers are willing to pay)
- `best_ask`: Lowest sell order price (what sellers are asking)
- `spread`: Difference between ask and bid (ask - bid)
- `midpoint`: Average of bid and ask ((bid + ask) / 2)

**Usage**:
- Check current market conditions before placing order
- Midpoint often used as "fair price" estimate
- Narrow spread = liquid market, wide spread = illiquid market

**Error Codes**:
- `VALIDATION_ERROR` (400) - Missing commodity query param
- `MARKET_NOT_FOUND` (404) - Market or commodity does not exist
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/economy/internal/handlers/economy.go:166-198`

---

### GET /markets/{market_id}/prices/{commodity}

Get detailed price information for a commodity.

**Authentication**: Required

**URL Parameters**:
- `market_id` (required): Market ID
- `commodity` (required): Commodity type

**Response** (200 OK):
```json
{
  "data": {
    "market_id": "market_sol_station",
    "commodity": "ore",
    "spot_price": "105.25",
    "index_price": "104.80",
    "forecast": "106.00",
    "change_percent": 0.43,
    "vwap": "105.10",
    "high_24h": "108.50",
    "low_24h": "102.00",
    "volume_24h": 15420
  }
}
```

**Field Descriptions**:
- `spot_price`: Current market price (EMA-smoothed, recommended for UI display)
- `index_price`: 24-hour average price (less volatile reference)
- `forecast`: Predicted next price (based on current trends)
- `change_percent`: Percentage change from last price (e.g., 0.43 = +0.43%)
- `vwap`: Volume-weighted average price (recent trades weighted by size)
- `high_24h`: Highest trade price in last 24 hours
- `low_24h`: Lowest trade price in last 24 hours
- `volume_24h`: Total quantity traded in last 24 hours

**Usage**:
- `spot_price` recommended for "current price" display
- `index_price` useful for contracts/long-term pricing
- `change_percent` for price trend indicators (green/red arrows)

**Error Codes**:
- `MARKET_NOT_FOUND` (404) - Market or commodity does not exist
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/economy/internal/handlers/economy.go:200-232`

---

### GET /markets/{market_id}/prices

Get prices for all commodities in a market.

**Authentication**: Required

**URL Parameters**:
- `market_id` (required): Market ID

**Response** (200 OK):
```json
{
  "data": {
    "market_id": "market_sol_station",
    "prices": [
      {
        "commodity": "ore",
        "spot_price": "105.25",
        "change_percent": 0.43,
        "volume_24h": 15420
      },
      {
        "commodity": "gas",
        "spot_price": "152.00",
        "change_percent": -1.20,
        "volume_24h": 8200
      },
      {
        "commodity": "electronics",
        "spot_price": "520.00",
        "change_percent": 2.15,
        "volume_24h": 3400
      }
    ]
  }
}
```

**Field Descriptions**:
- Returns simplified price data for all 10 commodities
- Useful for market overview displays

**Error Codes**:
- `MARKET_NOT_FOUND` (404) - Market does not exist
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/economy/internal/handlers/economy.go:234-272`

---

### GET /markets/{market_id}/trades

Get recent trade history for a commodity.

**Authentication**: Required

**URL Parameters**:
- `market_id` (required): Market ID

**Query Parameters**:
- `commodity` (required): Commodity type
- `limit` (optional): Number of trades (default: 50, max: 100)

**Response** (200 OK):
```json
{
  "data": {
    "market_id": "market_sol_station",
    "commodity": "ore",
    "trades": [
      {
        "trade_id": "trade-uuid-1",
        "price": "105.50",
        "quantity": 100,
        "timestamp": "2025-12-27T12:34:56.123456Z"
      },
      {
        "trade_id": "trade-uuid-2",
        "price": "105.00",
        "quantity": 75,
        "timestamp": "2025-12-27T12:30:12.123456Z"
      }
    ]
  }
}
```

**Field Descriptions**:
- `trades`: List of recent trades (most recent last)
- `price`: Execution price of trade
- `quantity`: Quantity traded
- `timestamp`: When trade occurred

**Usage**:
- Display recent market activity
- Calculate price trends
- Audit own trades

**Error Codes**:
- `VALIDATION_ERROR` (400) - Missing commodity query param
- `MARKET_NOT_FOUND` (404) - Market or commodity does not exist
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/economy/internal/handlers/economy.go:274-324`

---

## Price Discovery System

### VWAP Calculation

**Volume-Weighted Average Price** is the primary price calculation method:

```
VWAP = Σ(price × quantity) / Σ(quantity)
```

**Window**: 1 hour of recent trades

**Outlier Filtering**: Trades beyond 3 standard deviations are excluded

**Fallback**: If no trades, uses order book midpoint

**Code**: `/services/economy/internal/pricing/discovery.go:79-100`

---

### Price Modifiers

Prices are adjusted based on market conditions:

**Supply/Demand Ratio**:
```
modifier = 1 + (1 - supply/demand) × 0.1
price = base_price × modifier
```
- High demand, low supply → price increases
- High supply, low demand → price decreases

**Event Modifiers** (multiplicative):
- **War**: +20% (faction conflict in sector)
- **Blockade**: +50% (station under blockade)
- **Trade Disruption**: +10% (pirate activity, route disruption)

**Code**: `/services/economy/internal/pricing/discovery.go:101-120`

---

### Price Change Limits

**Max Change Per Tick**: 5% of last price

**Purpose**: Prevent manipulation and flash crashes

**Example**:
- Last price: 100.00
- Max increase: 105.00
- Max decrease: 95.00

If calculated price exceeds limits, it's clamped to max change.

**Code**: `/services/economy/internal/pricing/discovery.go:122-134`

---

### EMA Smoothing

**Exponential Moving Average** smooths price volatility:

**Periods**: 10 (configurable)

**Formula**:
```
EMA[t] = (price × α) + (EMA[t-1] × (1 - α))
where α = 2 / (periods + 1)
```

**Effect**: Gradual price changes, reduces noise

**Code**: `/services/economy/internal/pricing/discovery.go:136-138`

---

### 24-Hour Metrics

**Index Price**: Simple average of last 24h trades

**High/Low**: Highest and lowest trade prices in 24h window

**Volume**: Total quantity traded in 24h

**Usage**: Reference pricing, volatility analysis, market health

**Code**: `/services/economy/internal/pricing/discovery.go:139-143`

---

## Real-Time Economy Events

Economy activity is broadcast via SSE. See `04-REALTIME-SSE.apib` for subscription details.

**Event Channel**: `economy.market.{market_id}`

---

### Event: game.economy.trade

Published when a trade is executed (order matched).

**Event Payload**:
```json
{
  "market_id": "market_sol_station",
  "commodity": "ore",
  "trade_id": "trade-uuid-1",
  "buyer_id": "player-uuid-1",
  "seller_id": "player-uuid-2",
  "price": "105.50",
  "quantity": 100,
  "timestamp": 1735310400
}
```

**Field Descriptions**:
- `buyer_id`: Player who placed buy order
- `seller_id`: Player who placed sell order
- `price`: Execution price (may differ from both order prices)
- `quantity`: Quantity traded

**Usage**:
- Update market UI with latest trades
- Show "You sold X ore for Y credits" notification
- Update orderbook display

---

### Event: game.economy.price_update

Published when commodity price changes significantly (>1%).

**Event Payload**:
```json
{
  "market_id": "market_sol_station",
  "commodity": "ore",
  "old_price": "104.50",
  "new_price": "106.00",
  "change_percent": 1.43,
  "reason": "high_demand",
  "timestamp": 1735310400
}
```

**Field Descriptions**:
- `reason`: Cause of price change (`high_demand`, `war`, `blockade`, `trade_volume`)
- `change_percent`: Percentage change (e.g., 1.43 = +1.43%)

**Usage**:
- Alert players to significant price movements
- Show price trend indicators

---

## Trading Strategies

### Basic Buy/Sell

**Simple Trading**:
1. Check current price: `GET /markets/{id}/prices/{commodity}`
2. Place buy order slightly below spot price: `POST /markets/{id}/orders`
3. Wait for fill or cancel if no match
4. Sell when price rises

---

### Market Making

**Liquidity Provider Strategy**:
1. Get orderbook: `GET /markets/{id}/orderbook`
2. Place buy order at best_bid - 0.50
3. Place sell order at best_ask + 0.50
4. Profit from spread when both fill

**Risk**: Inventory risk if market moves against you

---

### Arbitrage

**Cross-Market Trading**:
1. Check prices at multiple markets: `GET /markets/{id1}/prices` and `GET /markets/{id2}/prices`
2. If price(market1) < price(market2):
   - Buy at market1
   - Fly to market2
   - Sell at market2
3. Profit from price difference

**Risk**: Prices may change during travel, fuel costs

---

### Volume Trading

**Bulk Orders**:
1. Get trade history: `GET /markets/{id}/trades`
2. Identify commodities with high 24h volume
3. Place large orders at competitive prices
4. Higher fill probability on high-volume commodities

---

## Market Examples

### Example: Place Buy Order

```javascript
// Buy 100 ore at 105.50 credits each
const response = await fetch(
  'http://192.168.122.76:8080/v1/markets/market_sol_station/orders',
  {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + accessToken,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      player_id: currentPlayerId,
      commodity: 'ore',
      side: 'buy',
      price: '105.50',
      quantity: 100
    })
  }
);

const result = await response.json();

if (result.data.status === 'filled') {
  console.log('Order completely filled!');
  console.log(`Filled ${result.data.fills.length} orders`);

  result.data.fills.forEach(fill => {
    console.log(`Bought ${fill.quantity} at ${fill.price} each`);
  });
} else if (result.data.status === 'partial') {
  console.log('Order partially filled, rest pending');
} else {
  console.log('Order placed in book, waiting for match');
}
```

---

### Example: Check Market Prices

```javascript
// Get all commodity prices at Sol Station
const response = await fetch(
  'http://192.168.122.76:8080/v1/markets/market_sol_station/prices',
  {
    headers: {
      'Authorization': 'Bearer ' + accessToken
    }
  }
);

const result = await response.json();

console.log(`Prices at ${result.data.market_id}:`);

result.data.prices.forEach(p => {
  const arrow = p.change_percent > 0 ? '↑' : '↓';
  const color = p.change_percent > 0 ? 'green' : 'red';

  console.log(`${p.commodity}: ${p.spot_price} ${arrow} ${p.change_percent.toFixed(2)}%`);
  console.log(`  24h volume: ${p.volume_24h}`);
});
```

---

### Example: Monitor Market Activity

```javascript
// Subscribe to economy events for Sol Station
const eventSource = new EventSource(
  'http://192.168.122.76:8080/v1/stream/gameplay?channels=economy.market.market_sol_station',
  {
    headers: {
      'Authorization': 'Bearer ' + accessToken
    }
  }
);

eventSource.addEventListener('game.economy.trade', (e) => {
  const data = JSON.parse(e.data);

  console.log(`Trade: ${data.quantity} ${data.commodity} at ${data.price}`);

  // Show notification if it's your trade
  if (data.buyer_id === currentPlayerId || data.seller_id === currentPlayerId) {
    showNotification(`Your order filled: ${data.quantity} ${data.commodity} at ${data.price}`);
  }

  // Update price chart
  updatePriceChart(data.commodity, data.price, data.timestamp);
});

eventSource.addEventListener('game.economy.price_update', (e) => {
  const data = JSON.parse(e.data);

  console.log(`Price change: ${data.commodity} ${data.old_price} → ${data.new_price}`);

  // Alert on significant changes
  if (Math.abs(data.change_percent) > 5) {
    showAlert(`${data.commodity} price ${data.change_percent > 0 ? 'up' : 'down'} ${Math.abs(data.change_percent).toFixed(1)}%!`);
  }
});
```

---

### Example: Cancel Order

```javascript
// Cancel a pending buy order
const response = await fetch(
  'http://192.168.122.76:8080/v1/markets/market_sol_station/orders/order-uuid-1?commodity=ore&side=buy',
  {
    method: 'DELETE',
    headers: {
      'Authorization': 'Bearer ' + accessToken
    }
  }
);

const result = await response.json();

if (result.data.success) {
  console.log('Order canceled, credits released');
}
```

---

## Summary

This document covers the **Economy Service**:

1. **POST /markets/{market_id}/orders**: Place buy/sell order
2. **DELETE /markets/{market_id}/orders/{order_id}**: Cancel order
3. **GET /markets/{market_id}/orderbook**: Get order book (bid/ask/spread)
4. **GET /markets/{market_id}/prices/{commodity}**: Get detailed price data
5. **GET /markets/{market_id}/prices**: Get all commodity prices
6. **GET /markets/{market_id}/trades**: Get trade history

**Key Features**:
- **Order Book System**: Price-time priority matching
- **10 Commodities**: ore, gas, crystals, water, organic, fuel, electronics, weapons, medicine, luxury
- **3 Default Markets**: Sol Station, Alpha Hub, Frontier Post
- **Dynamic Pricing**: VWAP-based with supply/demand modifiers
- **Price Modifiers**: War (+20%), blockade (+50%), disruption (+10%)
- **Price Limits**: Max 5% change per tick
- **24h Metrics**: VWAP, high, low, volume
- **Real-Time Events**: Trade executions, price updates

**Price Discovery**:
- **Base Price**: Volume-weighted average (1h window)
- **Modifiers**: Supply/demand ratio, war/blockade events
- **Smoothing**: 10-period EMA
- **Outlier Filter**: 3-sigma threshold

**Trading Strategies**:
- **Basic**: Buy low, sell high
- **Market Making**: Profit from spread
- **Arbitrage**: Cross-market price differences
- **Volume**: High-liquidity commodities

**Next Steps**:
- Read `04-REALTIME-SSE.apib` for economy event subscriptions
- Read `03B-WORLDSIM.apib` for inventory and station docking
- Read `06-APPENDICES.md` for complete commodity reference

---

**End of 03D-ECONOMY.apib**
