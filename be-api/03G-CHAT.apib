FORMAT: 1A
HOST: http://192.168.122.76:8080/v1

# SSW Galaxy MMO - Chat System (vNext 2.0)

**Version**: 2.0 (vNext)
**Status**: Implementation-Grounded
**Last Verified**: 2025-12-27
**Service**: Chat (Internal Port: 8087)

---

## Document Purpose

This document covers the **Chat Service**, responsible for:
- **Chat Rooms**: Sector, faction, alliance, global, DM, and group rooms
- **Messaging**: Real-time text communication via NATS and SSE
- **Room Management**: Create, join, leave rooms

**Code**: `/services/chat/`

**Related Documents**:
- See `01-OVERVIEW.apib` for global standards
- See `04-REALTIME-SSE.apib` for chat event subscriptions
- See `06-APPENDICES.md` for error codes

---

## Chat Overview

### Room Types

| Room Type | Description | Auto-Created | Max Members | Examples |
|-----------|-------------|--------------|-------------|----------|
| `sector` | Sector-specific chat | Yes | 100 | "Sol System Chat" (sector 0,0,0) |
| `faction` | Faction-wide chat | Yes | 500 | "Terran Federation" |
| `alliance` | Player alliance chat | No | 200 | "Trading Alliance" |
| `global` | Server-wide chat | Yes | Unlimited | "Global Chat" |
| `dm` | Direct message (2 players) | On demand | 2 | Private conversation |
| `group` | Custom group chat | No | 50 | "Mining Crew Alpha" |

**Auto-Created Rooms**:
- Sector rooms created when first player enters sector
- Faction rooms created with faction
- Global room exists always

**Player-Created Rooms**:
- `alliance`, `group` types can be created by players
- `dm` rooms created automatically when starting private chat

---

## Endpoints

### POST /v1/chat/messages

Send a chat message to a room.

**Authentication**: Required

**Request Body**:
```json
{
  "room_id": "room-uuid-12345",
  "sender_id": "player-uuid-1",
  "message": "Anyone want to team up for trading?"
}
```

**Validation Rules**:
- `room_id`: Must be valid UUID, room must exist
- `sender_id`: Must match authenticated profile ID
- `message`: Required, 1-500 characters, no profanity (filtered)

**Response** (200 OK):
```json
{
  "data": {
    "message_id": "msg-uuid-1",
    "room_id": "room-uuid-12345",
    "sender_id": "player-uuid-1",
    "sender_name": "Captain Nova",
    "message": "Anyone want to team up for trading?",
    "timestamp": "2025-12-27T12:34:56.123456Z"
  }
}
```

**NATS Event Published**:
- Channel: `chat.room.{room_id}`
- Event Type: `game.chat.message`
- Subscribers: All players in room receive message via SSE

**Error Codes**:
- `VALIDATION_ERROR` (400) - Invalid request body, message too long, or profanity detected
- `ROOM_NOT_FOUND` (404) - Room does not exist
- `FORBIDDEN` (403) - Sender not a member of room
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/chat/internal/handlers/chat.go:25-80`

---

### GET /v1/chat/rooms

List chat rooms for the authenticated player.

**Authentication**: Required

**Query Parameters**:
- `player_id` (required): Profile ID
- `type` (optional): Filter by room type (`sector`, `faction`, `alliance`, `global`, `dm`, `group`)

**Response** (200 OK):
```json
{
  "data": [
    {
      "id": "room-uuid-1",
      "type": "sector",
      "name": "Sol System Chat",
      "owner_id": null,
      "member_count": 24,
      "max_members": 100,
      "created_at": "2025-12-20T10:00:00Z"
    },
    {
      "id": "room-uuid-2",
      "type": "faction",
      "name": "Terran Federation",
      "owner_id": null,
      "member_count": 142,
      "max_members": 500,
      "created_at": "2025-12-01T00:00:00Z"
    },
    {
      "id": "room-uuid-3",
      "type": "group",
      "name": "Mining Crew Alpha",
      "owner_id": "player-uuid-5",
      "member_count": 8,
      "max_members": 50,
      "created_at": "2025-12-25T14:30:00Z"
    }
  ]
}
```

**Field Descriptions**:
- `owner_id`: Creator of room (null for auto-created rooms like sector/faction)
- `member_count`: Current number of members in room
- `max_members`: Maximum capacity (null for unlimited)

**Error Codes**:
- `VALIDATION_ERROR` (400) - Missing or invalid player_id
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/chat/internal/handlers/chat.go:85-130`

---

### GET /v1/chat/rooms/{room_id}

Get details of a specific chat room.

**Authentication**: Required

**URL Parameters**:
- `room_id` (required): Room UUID

**Response** (200 OK):
```json
{
  "data": {
    "id": "room-uuid-1",
    "type": "sector",
    "name": "Sol System Chat",
    "owner_id": null,
    "members": [
      {
        "player_id": "player-uuid-1",
        "player_name": "Captain Nova",
        "joined_at": "2025-12-27T10:00:00Z"
      },
      {
        "player_id": "player-uuid-2",
        "player_name": "Commander Atlas",
        "joined_at": "2025-12-27T11:15:00Z"
      }
    ],
    "member_count": 24,
    "max_members": 100,
    "created_at": "2025-12-20T10:00:00Z"
  }
}
```

**Error Codes**:
- `ROOM_NOT_FOUND` (404) - Room does not exist
- `FORBIDDEN` (403) - Not a member of room (for private rooms)
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/chat/internal/handlers/chat.go:135-180`

---

### POST /v1/chat/rooms

Create a new chat room.

**Authentication**: Required

**Request Body**:
```json
{
  "type": "group",
  "name": "Trading Alliance",
  "owner_id": "player-uuid-1",
  "max_members": 50
}
```

**Validation Rules**:
- `type`: Must be `alliance` or `group` (cannot create sector/faction/global/dm)
- `name`: Required, 3-50 characters, unique within type
- `owner_id`: Must match authenticated profile ID
- `max_members`: Optional, default 50, max 200

**Response** (201 Created):
```json
{
  "data": {
    "id": "room-uuid-new",
    "type": "group",
    "name": "Trading Alliance",
    "owner_id": "player-uuid-1",
    "member_count": 1,
    "max_members": 50,
    "created_at": "2025-12-27T12:34:56.123456Z"
  }
}
```

**Notes**:
- Creator is automatically added as first member
- Creator has admin privileges (kick, delete room)

**Error Codes**:
- `VALIDATION_ERROR` (400) - Invalid request body or room type
- `NAME_TAKEN` (409) - Room name already exists for this type
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/chat/internal/handlers/chat.go:185-240`

---

### POST /v1/chat/rooms/{room_id}/join

Join a chat room.

**Authentication**: Required

**URL Parameters**:
- `room_id` (required): Room UUID

**Request Body**:
```json
{
  "player_id": "player-uuid-1"
}
```

**Validation Rules**:
- `player_id`: Must match authenticated profile ID
- Room must not be at max capacity
- Player must not already be in room

**Response** (200 OK):
```json
{
  "data": {
    "success": true,
    "room_id": "room-uuid-1",
    "member_count": 25
  }
}
```

**Error Codes**:
- `ROOM_NOT_FOUND` (404) - Room does not exist
- `ROOM_FULL` (409) - Room at maximum capacity
- `VALIDATION_ERROR` (400) - Player already in room
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/chat/internal/handlers/chat.go:245-290`

---

### POST /v1/chat/rooms/{room_id}/leave

Leave a chat room.

**Authentication**: Required

**URL Parameters**:
- `room_id` (required): Room UUID

**Request Body**:
```json
{
  "player_id": "player-uuid-1"
}
```

**Response** (200 OK):
```json
{
  "data": {
    "success": true,
    "room_id": "room-uuid-1",
    "member_count": 23
  }
}
```

**Notes**:
- Cannot leave auto-joined rooms (sector, faction) - auto-managed by presence
- If owner leaves player-created room, ownership transfers to next member or room is deleted

**Error Codes**:
- `ROOM_NOT_FOUND` (404) - Room does not exist
- `VALIDATION_ERROR` (400) - Player not in room
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/chat/internal/handlers/chat.go:295-340`

---

### POST /v1/chat/private

Start a private chat (DM) with another player.

**Authentication**: Required

**Request Body**:
```json
{
  "player1": "player-uuid-1",
  "player2": "player-uuid-2"
}
```

**Validation Rules**:
- One of `player1` or `player2` must match authenticated profile ID
- Both players must exist
- Creates new DM room if one doesn't exist, or returns existing DM room

**Response** (200 OK):
```json
{
  "data": {
    "room_id": "dm-room-uuid",
    "type": "dm",
    "name": "Captain Nova <-> Commander Atlas",
    "members": [
      {
        "player_id": "player-uuid-1",
        "player_name": "Captain Nova"
      },
      {
        "player_id": "player-uuid-2",
        "player_name": "Commander Atlas"
      }
    ],
    "created_at": "2025-12-27T12:34:56.123456Z"
  }
}
```

**DM Room Naming**: `{player1_name} <-> {player2_name}`

**Error Codes**:
- `NOT_FOUND` (404) - One or both players do not exist
- `VALIDATION_ERROR` (400) - Cannot DM yourself
- `AUTH_REQUIRED` (401) - Missing or invalid authentication token

**Code**: `/services/chat/internal/handlers/chat.go:345-400`

---

## Real-Time Chat Events

Chat messages are delivered in real-time via SSE. See `04-REALTIME-SSE.apib` for event subscription details.

**Event Channel**: `chat.room.{room_id}`

**Event Type**: `game.chat.message`

**Event Payload**:
```json
{
  "room_id": "room-uuid-1",
  "room_type": "sector",
  "sender_id": "player-uuid-1",
  "sender_name": "Captain Nova",
  "message": "Anyone want to team up for trading?",
  "timestamp": 1735310400
}
```

**Client Integration Example**:
```javascript
// Subscribe to room's chat channel
const eventSource = new EventSource(
  'http://192.168.122.76:8080/v1/stream/gameplay?channels=chat.room.room-uuid-1'
);

eventSource.addEventListener('game.chat.message', (e) => {
  const data = JSON.parse(e.data);
  console.log(`[${data.room_type}] ${data.sender_name}: ${data.message}`);

  // Update chat UI
  addMessageToUI(data.room_id, data.sender_name, data.message);
});
```

---

## Auto-Join Behavior

### Sector Rooms

**Auto-Join**: When ship jumps to a sector, player automatically joins sector room

**Auto-Leave**: When ship leaves sector, player automatically leaves sector room

**Implementation**: WorldSim service publishes jump events, chat service subscribes and manages membership

---

### Faction Rooms

**Auto-Join**: When player gains positive reputation with faction, auto-joined to faction room

**Auto-Leave**: When player reputation drops to hostile, auto-removed from faction room

**Implementation**: Social service publishes reputation events, chat service manages membership

---

### Global Room

**Auto-Join**: All players are always in global room

**Cannot Leave**: Global room membership is permanent

---

## Profanity Filter

**Status**: Basic profanity filter implemented

**Behavior**:
- Messages scanned for profanity on send
- Profane words replaced with `***`
- Severe profanity rejects message with `VALIDATION_ERROR`

**Filter List**: Configurable word list in `/services/chat/config/profanity.txt`

**Future**: Machine learning-based toxicity detection

---

## Rate Limiting

**Message Rate Limit**: 10 messages per minute per player

**Enforcement**: Redis-backed rate limiting

**Error**: `RATE_LIMITED` (429) when limit exceeded

**Cooldown**: Must wait before sending next message

---

## Summary

This document covers the **Chat Service**:

1. **POST /v1/chat/messages**: Send message to room
2. **GET /v1/chat/rooms**: List player's rooms
3. **GET /v1/chat/rooms/{room_id}**: Get room details
4. **POST /v1/chat/rooms**: Create group/alliance room
5. **POST /v1/chat/rooms/{room_id}/join**: Join room
6. **POST /v1/chat/rooms/{room_id}/leave**: Leave room
7. **POST /v1/chat/private**: Start DM with player

**Key Features**:
- **6 Room Types**: sector, faction, alliance, global, dm, group
- **Real-Time Messaging**: Via NATS and SSE
- **Auto-Join**: Sector and faction rooms auto-managed
- **Profanity Filter**: Basic word filtering
- **Rate Limiting**: 10 messages/minute

**Next Steps**:
- Read `04-REALTIME-SSE.apib` for chat event subscription
- Read `03F-SOCIAL.apib` for faction room integration
- Read `01-OVERVIEW.apib` for rate limiting details

---

**End of 03G-CHAT.apib**
