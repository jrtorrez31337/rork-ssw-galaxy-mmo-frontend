# Identity Service - Characters & Ships

**Service**: Identity
**Base Path**: `/v1/characters`, `/v1/ships`
**Port**: 8081 (internal), proxied via gateway at :8080
**Authentication**: Required (JWT Bearer token)
**Code Location**: `/services/identity/`

---

## Overview

The Identity Service manages player characters and ships. After authentication (see `02-AUTH-ACCOUNTS.apib`), players create characters with attribute allocation and ships with stat allocation. Both use point-buy systems with validation.

**Key Concepts**:
- **Profile ID**: From auth context (`/v1/auth/me` → `profile_id`), used as owner
- **Character**: Player persona with 5 attributes (total 20 points)
- **Ship**: Starship with 5 stats (total 30 points) and type bonuses
- **Ownership**: Characters and ships belong to a profile (not account)

---

## Characters

### POST /v1/characters

Create a new character with attribute allocation.

**Authentication**: Required (JWT)

**Request Headers**:
```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**Request Body**:
```json
{
  "profile_id": "38a87211-63b6-409b-b433-8f443e333953",
  "name": "Captain Stellar",
  "home_sector": "sol",
  "attributes": {
    "piloting": 6,
    "engineering": 4,
    "science": 3,
    "tactics": 5,
    "leadership": 2
  }
}
```

**Request Schema**:

| Field | JSON Tag | Type | Required | Validation | Default | Notes |
|-------|----------|------|----------|------------|---------|-------|
| profile_id | `profile_id` | string | Yes | UUID format | - | From `/v1/auth/me` |
| name | `name` | string | Yes | Length: 3-32 chars | - | Must be unique per profile |
| home_sector | `home_sector` | string | Yes | Valid sector ID | - | Starting location |
| attributes | `attributes` | object | Yes | See below | - | CharacterAttributes object |

**CharacterAttributes Schema**:

| Field | JSON Tag | Type | Required | Validation | Default | Notes |
|-------|----------|------|----------|------------|---------|-------|
| piloting | `piloting` | int | Yes | Range: 1-10, **Sum must = 20** | - | Ship handling, maneuverability |
| engineering | `engineering` | int | Yes | Range: 1-10, **Sum must = 20** | - | Tech/repair bonuses, systems |
| science | `science` | int | Yes | Range: 1-10, **Sum must = 20** | - | Research, discovery, scanning |
| tactics | `tactics` | int | Yes | Range: 1-10, **Sum must = 20** | - | Combat effectiveness, strategy |
| leadership | `leadership` | int | Yes | Range: 1-10, **Sum must = 20** | - | Crew bonuses, faction influence |

**Validation Rules** (Code: `/services/identity/internal/handlers/character.go:142-160`):
1. **Total Points**: All 5 attributes must sum to exactly 20
   - Error if sum != 20: `INSUFFICIENT_POINTS` (400)
2. **Range**: Each attribute must be between 1-10 (inclusive)
   - Error if out of range: `ATTRIBUTE_OUT_OF_RANGE` (400)
3. **Name Uniqueness**: Character name must be unique within the profile
   - Error if duplicate: `NAME_TAKEN` (409)
4. **Name Length**: 3-32 characters
   - Error if invalid: `VALIDATION_ERROR` (400)

**Success Response** (201 Created):
```json
{
  "data": {
    "id": "97544ebf-cec5-4090-ae18-439ea74785b2",
    "profile_id": "38a87211-63b6-409b-b433-8f443e333953",
    "name": "Captain Stellar",
    "home_sector": "sol",
    "attributes": {
      "piloting": 6,
      "engineering": 4,
      "science": 3,
      "tactics": 5,
      "leadership": 2
    },
    "created_at": "2025-12-23T18:04:48.883723Z"
  }
}
```

**Response Schema**:

| Field | JSON Tag | Type | Always Present | Notes |
|-------|----------|------|----------------|-------|
| id | `id` | string | Yes | UUID of created character |
| profile_id | `profile_id` | string | Yes | Owner profile UUID |
| name | `name` | string | Yes | Character display name |
| home_sector | `home_sector` | string | Yes | Starting sector |
| attributes | `attributes` | object | Yes | CharacterAttributes |
| created_at | `created_at` | string | Yes | RFC3339 timestamp |

**Error Responses**:

| HTTP Status | Error Code | Message | Cause |
|-------------|------------|---------|-------|
| 400 | `VALIDATION_ERROR` | "Invalid request" | Malformed JSON or missing required fields |
| 400 | `INSUFFICIENT_POINTS` | "Attributes must sum to 20" | Attribute sum != 20 |
| 400 | `ATTRIBUTE_OUT_OF_RANGE` | "Attribute must be between 1-10" | Attribute < 1 or > 10 |
| 401 | `AUTH_REQUIRED` | "Authorization required" | Missing/invalid JWT token |
| 409 | `NAME_TAKEN` | "Character name already exists" | Name conflict within profile |
| 500 | `SERVER_ERROR` | "Internal server error" | Database or service failure |

---

### GET /v1/characters/{id}

Get character by ID.

**Authentication**: Required

**Path Parameters**:
- `id` (string, required): Character UUID

**Success Response** (200 OK):
```json
{
  "data": {
    "id": "97544ebf-cec5-4090-ae18-439ea74785b2",
    "profile_id": "38a87211-63b6-409b-b433-8f443e333953",
    "name": "Captain Stellar",
    "home_sector": "sol",
    "attributes": {
      "piloting": 6,
      "engineering": 4,
      "science": 3,
      "tactics": 5,
      "leadership": 2
    },
    "created_at": "2025-12-23T18:04:48.883723Z"
  }
}
```

**Error Responses**:
- `404 NOT_FOUND` - Character does not exist
- `401 AUTH_REQUIRED` - Not authenticated

---

### GET /v1/characters/by-profile/{profile_id}

Get all characters for a profile.

**Authentication**: Required

**Path Parameters**:
- `profile_id` (string, required): Profile UUID

**Success Response** (200 OK):
```json
{
  "data": [
    {
      "id": "uuid",
      "profile_id": "uuid",
      "name": "Captain Stellar",
      "home_sector": "sol",
      "attributes": {
        "piloting": 6,
        "engineering": 4,
        "science": 3,
        "tactics": 5,
        "leadership": 2
      },
      "created_at": "2025-12-23T18:04:48.883723Z"
    },
    {
      "id": "uuid2",
      "profile_id": "uuid",
      "name": "Commander Nova",
      "home_sector": "alpha_centauri",
      "attributes": {
        "piloting": 3,
        "engineering": 8,
        "science": 5,
        "tactics": 2,
        "leadership": 2
      },
      "created_at": "2025-12-24T10:15:30.123456Z"
    }
  ]
}
```

**Response Format**:
- Returns array of CharacterResponse objects (may be empty)
- No pagination (⚠️ **Performance Risk**: Could return 100+ characters)

**Error Responses**:
- `404 NOT_FOUND` - Profile does not exist
- `401 AUTH_REQUIRED` - Not authenticated

---

### PATCH /v1/characters/{id}

Update character name (only mutable field).

**Authentication**: Required

**Path Parameters**:
- `id` (string, required): Character UUID

**Request Body**:
```json
{
  "name": "Admiral Stellar"
}
```

**Request Schema**:

| Field | JSON Tag | Type | Required | Validation |
|-------|----------|------|----------|------------|
| name | `name` | string | Yes | Length: 3-32 chars, unique per profile |

**Success Response** (200 OK):
```json
{
  "data": {
    "message": "Character updated successfully"
  }
}
```

**Error Responses**:
- `400 VALIDATION_ERROR` - Invalid name format
- `404 NOT_FOUND` - Character doesn't exist
- `409 NAME_TAKEN` - Name conflict
- `401 AUTH_REQUIRED` - Not authenticated

**Note**: Attributes and home_sector are immutable after creation.

---

## Ships

### POST /v1/ships

Create ship with stat allocation and type bonuses.

**Authentication**: Required (JWT)

**Request Headers**:
```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**Request Body**:
```json
{
  "owner_id": "38a87211-63b6-409b-b433-8f443e333953",
  "ship_type": "scout",
  "name": "Star Runner",
  "stat_allocation": {
    "hull_strength": 4,
    "shield_capacity": 5,
    "speed": 10,
    "cargo_space": 3,
    "sensors": 8
  }
}
```

**Request Schema**:

| Field | JSON Tag | Type | Required | Validation | Default | Notes |
|-------|----------|------|----------|------------|---------|-------|
| owner_id | `owner_id` | string | Yes | UUID format | - | Profile ID (from auth) |
| ship_type | `ship_type` | string | Yes | Enum: see below | - | Determines bonuses |
| name | `name` | string | No | Length: 3-32 chars | - | Optional ship name |
| stat_allocation | `stat_allocation` | object | Yes | See below | - | ShipStats object |

**Ship Types & Bonuses**:

| Type | Hull Bonus | Shield Bonus | Speed Bonus | Cargo Bonus | Sensor Bonus |
|------|------------|--------------|-------------|-------------|--------------|
| `scout` | - | - | +2 | - | +2 |
| `fighter` | +300 HP | +100 | - | - | - |
| `trader` | +100 HP | - | - | +40 units | - |
| `explorer` | - | - | +1 | +10 units | +2 |

**ShipStats Schema**:

| Field | JSON Tag | Type | Required | Validation | Default | Notes |
|-------|----------|------|----------|------------|---------|-------|
| hull_strength | `hull_strength` | int | Yes | Range: 1-15, **Sum must = 30** | - | Base hull HP (× 100) |
| shield_capacity | `shield_capacity` | int | Yes | Range: 1-15, **Sum must = 30** | - | Base shield HP (× 50) |
| speed | `speed` | int | Yes | Range: 1-15, **Sum must = 30** | - | Movement speed |
| cargo_space | `cargo_space` | int | Yes | Range: 1-15, **Sum must = 30** | - | Cargo capacity (× 10) |
| sensors | `sensors` | int | Yes | Range: 1-15, **Sum must = 30** | - | Sensor range |

**Stat Calculations** (Code: `/services/identity/internal/handlers/ship.go:220-250`):
- **Hull Max** = (hull_strength × 100) + type_bonus
  - Example: Scout with hull_strength=4 → 400 HP (no bonus)
  - Example: Fighter with hull_strength=4 → 700 HP (+300 bonus)
- **Shield Max** = (shield_capacity × 50) + type_bonus
  - Example: Scout with shield_capacity=5 → 250 (no bonus)
  - Example: Fighter with shield_capacity=5 → 350 (+100 bonus)
- **Cargo Capacity** = (cargo_space × 10) + type_bonus
  - Example: Scout with cargo_space=3 → 30 units (no bonus)
  - Example: Trader with cargo_space=3 → 70 units (+40 bonus)
- **Speed** = speed + type_bonus
  - Example: Scout with speed=10 → 12 (+2 bonus)
- **Sensor Range** = sensors + type_bonus
  - Example: Scout with sensors=8 → 10 (+2 bonus)

**Validation Rules** (Code: `/services/identity/internal/handlers/ship.go:178-200`):
1. **Total Points**: All 5 stats must sum to exactly 30
   - Error if sum != 30: `INSUFFICIENT_POINTS` (400)
2. **Range**: Each stat must be between 1-15 (inclusive)
   - Error if out of range: `STAT_OUT_OF_RANGE` (400)
3. **Ship Type**: Must be one of: `scout`, `fighter`, `trader`, `explorer`
   - Error if invalid: `INVALID_SHIP_TYPE` (400)
4. **Name Length**: If provided, 3-32 characters
   - Error if invalid: `VALIDATION_ERROR` (400)

**Success Response** (201 Created):
```json
{
  "data": {
    "id": "c8cad90d-fec3-4f88-a59f-2a80d074eced",
    "owner_id": "38a87211-63b6-409b-b433-8f443e333953",
    "ship_type": "scout",
    "name": "Star Runner",
    "hull_points": 400,
    "hull_max": 400,
    "shield_points": 250,
    "shield_max": 250,
    "speed": 12,
    "cargo_capacity": 30,
    "sensor_range": 10,
    "location_sector": "sol",
    "fuel_current": 100.0,
    "fuel_capacity": 100.0,
    "docked_at": null,
    "last_jump_at": null,
    "position": {
      "x": 0,
      "y": 0,
      "z": 0
    },
    "in_combat": false,
    "created_at": "2025-12-23T18:04:48.916113Z",
    "stat_allocation": {
      "hull_strength": 4,
      "shield_capacity": 5,
      "speed": 10,
      "cargo_space": 3,
      "sensors": 8
    }
  }
}
```

**Response Schema**:

| Field | JSON Tag | Type | Always Present | Notes |
|-------|----------|------|----------------|-------|
| id | `id` | string | Yes | Ship UUID |
| owner_id | `owner_id` | string | Yes | Profile UUID |
| ship_type | `ship_type` | string | Yes | scout/fighter/trader/explorer |
| name | `name` | string | No | Optional ship name |
| hull_points | `hull_points` | int | Yes | Current hull HP |
| hull_max | `hull_max` | int | Yes | Maximum hull HP (with bonuses) |
| shield_points | `shield_points` | int | Yes | Current shield HP |
| shield_max | `shield_max` | int | Yes | Maximum shield HP (with bonuses) |
| speed | `speed` | int | Yes | **Final speed (with bonuses)** ⚠️ NOT in v1.2 docs |
| cargo_capacity | `cargo_capacity` | int | Yes | Total cargo space (with bonuses) |
| sensor_range | `sensor_range` | int | Yes | **Final sensor range (with bonuses)** ⚠️ NOT in v1.2 docs |
| location_sector | `location_sector` | string | Yes | Current sector (starts at home) |
| fuel_current | `fuel_current` | float64 | Yes | Current fuel level |
| fuel_capacity | `fuel_capacity` | float64 | Yes | Max fuel (always 100.0) |
| docked_at | `docked_at` | string | No | Station UUID if docked, else null |
| last_jump_at | `last_jump_at` | string | No | RFC3339 timestamp or null |
| position | `position` | object | Yes | Vector3 {x, y, z} in sector |
| in_combat | `in_combat` | bool | Yes | Combat flag |
| created_at | `created_at` | string | Yes | RFC3339 timestamp |
| stat_allocation | `stat_allocation` | object | Yes | ShipStats (base values) |

**⚠️ Schema Change from v1.2**:
- Added `speed` field (calculated from stat + bonus)
- Added `sensor_range` field (calculated from stat + bonus)
- These were missing in v1.2 documentation but always returned by API

**Error Responses**:

| HTTP Status | Error Code | Message | Cause |
|-------------|------------|---------|-------|
| 400 | `VALIDATION_ERROR` | "Invalid request" | Malformed JSON or missing required fields |
| 400 | `INSUFFICIENT_POINTS` | "Stats must sum to 30" | Stat sum != 30 |
| 400 | `STAT_OUT_OF_RANGE` | "Stat must be between 1-15" | Stat < 1 or > 15 |
| 400 | `INVALID_SHIP_TYPE` | "Invalid ship type" | Ship type not recognized |
| 401 | `AUTH_REQUIRED` | "Authorization required" | Missing/invalid JWT token |
| 500 | `SERVER_ERROR` | "Internal server error" | Database or service failure |

---

### GET /v1/ships/{id}

Get ship by ID.

**Authentication**: Required

**Path Parameters**:
- `id` (string, required): Ship UUID

**Success Response** (200 OK):
- Same schema as ship creation response (see above)

**Error Responses**:
- `404 NOT_FOUND` - Ship does not exist
- `401 AUTH_REQUIRED` - Not authenticated

---

### GET /v1/ships/by-owner/{owner_id}

Get all ships for owner (profile ID).

**Authentication**: Required

**Path Parameters**:
- `owner_id` (string, required): Profile UUID

**Success Response** (200 OK):
```json
{
  "data": [
    {
      "id": "c8cad90d-fec3-4f88-a59f-2a80d074eced",
      "owner_id": "38a87211-63b6-409b-b433-8f443e333953",
      "ship_type": "scout",
      "name": "Star Runner",
      "hull_points": 400,
      "hull_max": 400,
      "shield_points": 250,
      "shield_max": 250,
      "speed": 12,
      "cargo_capacity": 30,
      "sensor_range": 10,
      "location_sector": "sol",
      "fuel_current": 47.5,
      "fuel_capacity": 100.0,
      "docked_at": null,
      "last_jump_at": "2025-12-27T14:23:15.123456Z",
      "position": {"x": 1500, "y": -200, "z": 800},
      "in_combat": false,
      "created_at": "2025-12-23T18:04:48.916113Z",
      "stat_allocation": {
        "hull_strength": 4,
        "shield_capacity": 5,
        "speed": 10,
        "cargo_space": 3,
        "sensors": 8
      }
    }
  ]
}
```

**Response Format**:
- Returns array of ShipResponse objects (may be empty)
- No pagination (⚠️ **Performance Risk**: Could return 100+ ships)

**Error Responses**:
- `404 NOT_FOUND` - Owner/profile does not exist
- `401 AUTH_REQUIRED` - Not authenticated

---

### PATCH /v1/ships/{id}

Update ship name (only mutable field).

**Authentication**: Required

**Path Parameters**:
- `id` (string, required): Ship UUID

**Request Body**:
```json
{
  "name": "Void Dancer"
}
```

**Request Schema**:

| Field | JSON Tag | Type | Required | Validation |
|-------|----------|------|----------|------------|
| name | `name` | string | Yes | Length: 3-32 chars |

**Success Response** (200 OK):
```json
{
  "data": {
    "message": "Ship updated successfully"
  }
}
```

**Error Responses**:
- `400 VALIDATION_ERROR` - Invalid name format
- `404 NOT_FOUND` - Ship doesn't exist
- `401 AUTH_REQUIRED` - Not authenticated

**Note**: Ship type and stat_allocation are immutable after creation. Ship state (hull, shields, fuel, location) is updated via other services (WorldSim, Combat).

---

## Code Pointers

**Character Handlers**:
- Create: `/services/identity/internal/handlers/character.go:70-180`
- Get by ID: `/services/identity/internal/handlers/character.go:185-220`
- Get by Profile: `/services/identity/internal/handlers/character.go:225-270`
- Update: `/services/identity/internal/handlers/character.go:275-330`

**Ship Handlers**:
- Create: `/services/identity/internal/handlers/ship.go:75-260`
- Get by ID: `/services/identity/internal/handlers/ship.go:265-305`
- Get by Owner: `/services/identity/internal/handlers/ship.go:310-360`
- Update: `/services/identity/internal/handlers/ship.go:365-420`

**Validation Logic**:
- Character attributes: `/services/identity/internal/handlers/character.go:142-160`
- Ship stats: `/services/identity/internal/handlers/ship.go:178-200`
- Ship type bonuses: `/services/identity/internal/handlers/ship.go:220-250`

---

## Quick Start Example (JavaScript)

```javascript
// 1. Authenticate (see 02-AUTH-ACCOUNTS.apib)
const authResponse = await fetch('http://192.168.122.76:8080/v1/auth/login', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({email: 'player@example.com', password: 'pass123'})
});
const {access_token, session_id} = (await authResponse.json()).data;

// 2. Get profile ID
const meResponse = await fetch('http://192.168.122.76:8080/v1/auth/me', {
  headers: {'Authorization': `Bearer ${access_token}`}
});
const {profile_id} = (await meResponse.json()).data;

// 3. Create character
const charResponse = await fetch('http://192.168.122.76:8080/v1/characters', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${access_token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    profile_id: profile_id,
    name: "Captain Nova",
    home_sector: "sol",
    attributes: {
      piloting: 7,
      engineering: 5,
      science: 2,
      tactics: 4,
      leadership: 2
    }
  })
});
const character = (await charResponse.json()).data;
console.log('Character created:', character.id);

// 4. Create ship
const shipResponse = await fetch('http://192.168.122.76:8080/v1/ships', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${access_token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    owner_id: profile_id,
    ship_type: "scout",
    name: "Stellar Wind",
    stat_allocation: {
      hull_strength: 5,
      shield_capacity: 6,
      speed: 8,
      cargo_space: 4,
      sensors: 7
    }
  })
});
const ship = (await shipResponse.json()).data;
console.log('Ship created:', ship.id);
console.log('Speed (with bonus):', ship.speed); // 8 + 2 = 10
console.log('Sensors (with bonus):', ship.sensor_range); // 7 + 2 = 9
```

---

**Next**: See `03B-WORLDSIM.apib` for movement, inventory, and mining.
